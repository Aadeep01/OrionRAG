import logging

from app.services.gemini_client import GeminiClient

logger = logging.getLogger(__name__)

async def evaluate_rag_response(
    query: str,
    response: str,
    context: str,
    gemini_client: GeminiClient
) -> dict[str, float]:
    """
    Evaluate a RAG response for Faithfulness and Relevance using Gemini.

    Args:
        query: The user's original question
        response: The answer generated by the RAG system
        context: The context provided to the LLM
        gemini_client: Client to make LLM calls

    Returns:
        Dictionary with 'faithfulness' and 'relevance' scores (0.0 to 1.0)
    """
    try:
        # 1. Faithfulness Evaluation
        faithfulness_prompt = f"""You are a RAG system evaluator.
        Task: Rate the faithfulness of the answer to the context.
        Does the answer rely ONLY on the provided context?

        Context:
        {context}

        Answer:
        {response}

        Score (0.0 to 1.0, where 1.0 is fully faithful):
        """

        faithfulness_res = await gemini_client.generate_content(faithfulness_prompt)
        try:
            faithfulness_score = float(faithfulness_res.strip())
        except ValueError:
            faithfulness_score = 0.0

        # 2. Relevance Evaluation
        relevance_prompt = f"""You are a RAG system evaluator.
        Task: Rate the relevance of the answer to the query.
        Does the answer actually answer the user's question?

        Query:
        {query}

        Answer:
        {response}

        Score (0.0 to 1.0, where 1.0 is fully relevant):
        """

        relevance_res = await gemini_client.generate_content(relevance_prompt)
        try:
            relevance_score = float(relevance_res.strip())
        except ValueError:
            relevance_score = 0.0

        return {
            "faithfulness": faithfulness_score,
            "relevance": relevance_score
        }

    except Exception as e:
        logger.error(f"Evaluation failed: {e}")
        return {"faithfulness": 0.0, "relevance": 0.0}
